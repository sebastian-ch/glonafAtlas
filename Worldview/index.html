<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <!--<link rel="shortcut icon" href="favicon.ico?" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'"> -->
    <title>World View</title>
    <script src="https://d3js.org/d3.v5.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/textures@1.2.0/dist/textures.js" type="text/javascript"></script>
    <script src='https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js' type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js" type="text/javascript"></script>
    <script src="https://bundle.run/geojson-rewind@0.3.1"></script>
    <script src='familyNames.js' type="text/javascript"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Calibri, Arial, sans-serif;
            overflow: hidden;
            background: #dcdcdc;
        }

        p {
            width: 80%;
            margin: 10px auto 10px auto;
        }

        button {
            width: 80%;
            margin: 10px auto 10px auto;
            margin-top: 4px;
            margin-bottom: 4px;
            border: 2px solid black;
            text-align: center;
            padding: 5px;
        }

        select {
            margin-top: 4px;
            width: 80%;
            text-align: center;
        }

        button:hover {
            background-color: gray;
            cursor: pointer;
        }

        .parent {
            display: grid;
            grid-template-columns: minmax(150px, 15%) 1fr;
        }

        .left {
            background: whitesmoke;
            height: 720px;
            text-align: center;

        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            height: 60px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            /* border-radius: 8px; */
            pointer-events: none;
        }

        #mapTitle {
            position: absolute;
            visibility: hidden;
            bottom: 120px;
            right: 400px;
            width: 300px;
            height: 50px;
            font: 30px;

        }

        .loader {
            text-align: center;
            line-height: 700px;
        }


        #legend {
            position: absolute;
            color: whitesmoke;
            padding: 8px 15px;
            background: rgba(25, 25, 25, 0.8);
            border-radius: 5px;
            border: 1px solid black;
            bottom: 40px;
            left: 250px;
            visibility: hidden;
        }

        #legend h2 {
            margin: 0;
            padding: 0;
            margin-bottom: 3px;
        }

        #legend span {
            width: 20px;
            height: 20px;
            float: left;
            margin: 0 10px 4px 0;
           
        }


        #legend label {
            line-height: 0.5em;
            font-size: 0.8em;
        }

        #legend label:after {
            content: '';
            display: block;
            clear: both;
        }

        #circleLegend {
            position: absolute;
            bottom: 40px;
            left: 300px;
            width: 140px;
            height: 100px;
           /* border: 1px solid black;
            background-color: lightblue; */
        }
        #circleLegend text {
            
            fill: black;
            font-size: 1.0em;
        }
    </style>
</head>

<body>

    <div class='parent' id='parent'>
        <div class='left'>
            <br>
            <br>
            <button id='home' onclick="openPage('../index.html')">Back To Home</button><br><br>



            <label for="fam">Filter by Taxon Family:</label>
            <br>

            <select name="fam" id="fam" onChange="getSelected(this);">
                <option value="start" selected>Choose</option>

            </select><br><br>
            <p>Select a color scheme below:</p>
            <button class='newMap' onclick="plain()">Plain Regions</button>
            <button class='newMap' onclick="gdpStyle()">GDP Per Capita</button>
            <button class='newMap' onclick="completeness()">Completeness</button>
            <button class='newMap' onclick="taxaCount()">Taxa Count Per Region</button>

            <br>
            <br>
            <br>
            <br>
            <p>This view allows for global visualizations of the GloNAF dataset. The above buttons allow for viewing different maps of the GloNAF regions.</p>
        </div>


        <div class="loader" id='loader'>
            <h2>Loading..</h2>
        </div>

        <div id='circleLegend'></div>
        <div id='legend'>
        </div>
        <div id='map'>
            <div id='mapTitle'></img>
            </div>

        </div>
    </div>
    <script>
        function openPage(url) {
            window.open(url)
        }
        const selectMenu = document.getElementById('fam');

        for (var x in familylist) {
            var el = document.createElement("option");
            el.textContent = familylist[x];
            el.value = familylist[x];
            selectMenu.appendChild(el);
        }

        var width = 1300;
        var height = 720;



        var taxList, points, nonislands, islands;
        var circlez;

        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)



        /*    var completeness1 = textures.lines()
                .lighter()
                .size(8)
                .background('#dddddd')
                .stroke('#cccccc');

            var completeness2 = textures.lines()
                .size(4)
                .lighter()
                .background('#dddddd')
                .stroke('#cccccc')

            svg.call(completeness1)
            svg.call(completeness2) */

        var promises = [
            d3.dsv('\t', "tax-list-small.txt"),
            d3.csv('../universalData/glonafAsCsv1.csv'),
            d3.json('../universalData/world-nonislands.geojson'),
            d3.json('../universalData/level1.json')
            //d3.csv('latest/islands.csv')

        ]

        Promise.all(promises).then(function(values) {

            var topo = topojson.feature(values[3], values[3].objects.level1)
            taxList = values[0]
            points = values[1]
            nonislands = values[2]
            //islands = values[3]

            makeMap(values[1], geojsonRewind(values[2], true), topo)


        })

        function makeMap(data, polys, backdrop) {

            //console.log(polys)

            var svg = d3.select("#map")
                .append("svg")
                .attr("width", width)
                .attr("height", height)

            var g = svg.append("g");

            var projection = d3.geoRobinson()
                .fitSize([width - 50, height - 50], polys);

            var geoPath = d3.geoPath()
                .projection(projection);

            svg
                .selectAll("path")
                .data(polys.features)
                .enter()
                .append("path")
                .attr("d", geoPath)
                .attr('fill', '#d6c6aa')
                .attr('class', 'continent')
            /*  .attr('fill', function(d) {
                  if (d.properties.completeness == 1) {

                      return completeness1.url()
                  } else if (d.properties.completeness == 2) {
                      return completeness2.url()
                  } else {
                      return '#dddddd'
                  }

              }) */

            /*.attr('stroke', 'black')
            .attr('stroke-width', '0.15') */
            //document.getElementById('loading').style.visibility = 'hidden';
            svg.selectAll('circle')
                .data(points)
                .enter()
                .append('circle')
                .attr('class', 'points')
                .attr('id', 'points')
                .attr('cx', function(d) {
                    return projection([d.LON, d.LAT])[0]
                })
                .attr('cy', function(d) {
                    return projection([d.LON, d.LAT])[1]
                })
                .attr('r', '3px')
                .attr('opacity', 0.8)
                .attr('fill', '#d6c6aa')
                .on('click', function(d) {
                    console.log(d.tnorm)
                })


            g
                .append('g')
                .selectAll('path')
                .data(backdrop.features)
                .enter()
                .append("path")
                .attr('class', 'back')
                .attr("d", geoPath)
                .attr('fill', 'whitesmoke')
                .style('opacity', 0.5);

            removeLoading()

        }


        function getSelected(sel) {

            if (sel.options[sel.selectedIndex].text != 'Choose') {
                //addLoading()
                doMath(sel.options[sel.selectedIndex].text)
            }

        }

        function doMath(selected) {

            var oneFam = []

            if (!points[0].hasOwnProperty(selected)) {

                

                console.log(selected)

                for (var x in points) {

                    var thisReg = points[x].region_id;

                    var filter = _.filter(taxList, function(o) { return o.region_id == thisReg && o.family_tpl == selected });
                    oneFam.push(filter.length);
                    points[x][selected] = filter.length;
                    //console.log(filter.length)
                    //console.log(oneFam.length);
                }

                //console.log(oneFam)
                //console.log(oneFam.length)
                setNewColor(selected, points, oneFam);

            } else {

                console.log('else')
                for (var x in points.features) {
                    oneFam.push(points.features[x].properties[selected])
                }

                setNewColor(selected, points, oneFam);

            }

        }


        function setNewColor(selected, points, oneFam) {

            d3.select('#thisLegend').remove();


            document.getElementById('mapTitle').style.visibility = 'visible';
            document.getElementById('mapTitle').innerHTML = "<h1>Family " + selected + "</h1>"

            var domainVals = d3.extent(oneFam);
            console.log(domainVals);
            //console.log(points)


            /* var sqrtEx = d3.scaleSqrt()
                 .domain([domainVals[0] + 1, domainVals[1]])
                 .range([1, 20]) */

            var linearScale = d3.scaleLinear()
                .domain(domainVals)
                .range([0.5, 30])


            if (domainVals[1] <= 30) {

                d3.selectAll('circle')
                    .transition()
                    .attr('r', function(d) {
                        return d[selected].toString() + 'px'

                    })
                    .attr('fill', '#8eac8e')

                valuesToShow = [domainVals[1] / 2, domainVals[1]]
                console.log(valuesToShow)
            } else {

                d3.selectAll('circle')
                    .transition()
                    .attr('r', function(d) {

                        if (d[selected] == 0) {
                            return '0px'
                        } else {
                            return linearScale(d[selected]) + 'px'
                        }
                    })
                    .attr('fill', '#8eac8e')

                valuesToShow = [Math.round(linearScale(domainVals[1] / 2)), linearScale(domainVals[1])]
                console.log('vals: ' + valuesToShow);
            }

            d3.selectAll('circle')
                .on("mouseover", function(d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("<b>Name: </b>" + d.name + "<br>" +
                            "# of " + selected + ": " + d[selected])
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");

                    d3.select(this).attr('stroke', 'black').attr('stroke-width', 1)
                })
                .on("mouseout", function(d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(this).attr('stroke-width', 0)
                })
                .on('click', function(d) {
                    console.log(this)
                })



            var legend = d3.select('#circleLegend')
                .append("svg")
                .attr('id', 'thisLegend')
                .attr("width", 300)
                .attr("height", 300)

            var xCircle = 30
            var xLabel = 80
            var yCircle = 100

            legend
                .selectAll("legend")
                .data(valuesToShow)
                .enter()
                .append("circle")
                .attr("cx", xCircle)
                .attr("cy", function(d) { return yCircle - d })
                .attr("r", function(d) { return d })
                .style("fill", "#8eac8e")
                .attr('opacity', 0.5)
                .attr("stroke", "#8eac8e")

            legend
                .selectAll("legend")
                .data(valuesToShow)
                .enter()
                .append("line")
                .attr('x1', function(d) { return xCircle + d })
                .attr('x2', xLabel)
                .attr('y1', function(d) { return yCircle - d })
                .attr('y2', function(d) { return yCircle - d })
                .attr('stroke', 'black')
                .style('stroke-dasharray', ('2,2'))
                .attr('shape-rendering', 'crispEdges')

            // Add legend: labels
            legend
                .selectAll("legend")
                .data(valuesToShow)
                //.data(domainVals)
                .enter()
                .append("text")
                .attr('x', xLabel)
                .attr('y', function(d) { return yCircle - d })
                .data([Math.round(domainVals[1] / 2), domainVals[1]])
                .text(function(d) { return d })
                .style("font-size", 10)
                .attr('alignment-baseline', 'middle')
                .attr('shape-rendering', 'crispEdges')



        }

        function gdpStyle() {

            var colorScheme = d3.scaleQuantile()
                .domain[0, 100]
                .range(d3.schemeOranges[5]);

            d3.selectAll('.continent').attr('fill', function(d) {
                colorScheme(d.properties.GDPpcRegion)
            })
        }

        function completeness() {

            document.getElementById('legend').innerHTML = ''
            document.getElementById('legend').style.visibility = 'visible'

            d3.selectAll('.continent').attr('fill', function(d) {

                //console.log(d);
                switch (d.properties.completeness) {
                    case 1:
                        //return '#fc8d59'
                        return '#fcaf8a'
                        break;
                    case 2:
                        //return '#ffffbf'
                        return '#ffffcb'
                        break;
                    default:
                        //return '#91cf60'
                        return '#b2dd8f'
                }
            })

            d3.selectAll('.points').attr('fill', function(d) {

                    switch (d.completeness) {
                        case '1':
                            return '#fcaf8a'
                            break;
                        case '2':
                            return '#ffffcb'
                            break;
                        default:
                            return '#b2dd8f'
                    }
                })
                .attr('r', '3px')




            document.getElementById('legend').innerHTML +=
                '<h2>Data Completeness</h2>' +
                `<span style="background:#91cf60"></span>` + '<label>Likely Nearly Complete (>90% naturalized taxa included)</label>' +
                `<span style="background:#ffffbf"></span>` + '<label>Likely Incomplete (between 50% and 90% of naturalized taxa included)</label>' +
                `<span style="background:#fc8d59"></span>` + '<label>Likely Very Incomplete(< 50% naturalized taxa included)</label>'


        }


        function taxaCount() {

            document.getElementById('legend').innerHTML = ''
            document.getElementById('legend').style.visibility = 'visible'

            if (document.getElementById('mapTitle').style.visibility == 'visible') {
                document.getElementById('mapTitle').style.visibility = 'hidden'
            }
            const colorScheme = d3.scaleQuantile()
                .domain([0, 1])
                .range(d3.schemeGreens[5]);
            d3.selectAll('.continent').attr('fill', function(d) {
                return colorScheme(d.properties.tnorm)
            })

            console.log(colorScheme.range())
            console.log(colorScheme.domain())
            /* console.log(colorScheme(0))
             console.log(colorScheme(0.3))
             console.log(colorScheme(0.6))
             console.log(colorScheme(0.9)) */

            d3.selectAll('.points').attr('fill', function(d) {
                    //console.log(d);
                    return colorScheme(d.tnorm)
                })
                .attr('r', '1px')


                var subscript = "2".sup();


            document.getElementById('legend').innerHTML +=
                '<h2>Normalized Taxa Count Per Area (Km' + subscript + ')</h2>' +
                `<span style="background:#006d2c; margin: 0 10px 0 0"></span>` + '<label>More Taxa Per Area</label>' +
                `<span style="background:#31a354; margin: 0 10px 0 0"></span>` + '<label></label>' +
                `<span style="background:#74c476; margin: 0 10px 0 0"></span>` + '<label></label>' +
                `<span style="background:#bae4b3; margin: 0 10px 0 0"></span>` + '<label></label>' +
                `<span style="background:#edf8e9; margin: 0 10px 0 0"></span>` + '<label>Less Taxa Per Area</label>'
                
        }


        function plain() {
            document.getElementById('legend').innerHTML = ''
            document.getElementById('legend').style.visibility = 'hidden'

            document.getElementById('mapTitle').style.visibility = 'hidden';
            d3.selectAll('.continent').attr('fill', '#dacbb2')
            d3.selectAll('.points').attr('fill', '#dacbb2')
                .attr('r', '3px')
        }


        function removeLoading() {
            var el = document.getElementById('loader');
            el.parentNode.removeChild(el);
        }

        function addLoading() {

        }
    </script>

</body>

</html>